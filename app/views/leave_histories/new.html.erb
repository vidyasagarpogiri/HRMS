<div class="row">
  <div class="col-lg-12">
    <div class="panel panel-info">
      <div class="panel-heading"> 
        Leave Form
      </div>         
      <div class="panel-body">                 
        <% if @employee.reporting_manager.present? %> 
          <% if total_balance_leaves(@employee) <= 0 %>
            <div class="alert alert-danger alert-dismissable">
              <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
              Your Have No remaining leaves Please confirm before apply
            </div>
          <% end %>
          <% if @error.present? %>
            <div class="alert alert-danger alert-dismissable">
              <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
              <%= @error%>
            </div>
          <% end %>
          <% if flash[:error].present? %>
            <div class="alert alert-danger alert-dismissable">
              <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
              <%= flash[:error] %>
            </div>
          <% end %>                               

        <!-- rendering leave form                 --> 
         <%= render "leave_histories/apply_form" %>
       <!--  ---------------------------------------->
          <div class="alert-message alert alert-info alert-dismissable">
            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
            You have crossed the limit of your balace leaves
          </div>                                                                  
        <% else %>
        <div class="alert alert-success alert-dismissable">
            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
             You Have No Reporting Manager,  Please Contact HR Manager.
        </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
<script>
$(function(){
    $('.half_day').hide();
    $(".alert-message").hide();
     $('.floatingleave').hide();
     
    $('.rb1').click(function(){
      $('.full_day').hide();
      $('.half_day').show();
      $("#half_day").prop('required', true);
      $("#floating_leave").removeAttr("required");
      $("#full_day_from").removeAttr("required");
      $("#full_day_to").removeAttr("required");
    });
    $('.rb2').click(function(){
      $('.half_day').hide();
      $('.full_day').show();
      $("#full_day_from").prop('required', true);
      $("#full_day_to").prop('required', true);
      $("#half_day").removeAttr("required");
      $("#floating_leave").removeAttr("required");
    });
    
    
    var startDate = new Date('01/01/1900');
    var FromEndDate = new Date();
    var ToEndDate = new Date();

    $('.leave-form-date').datepicker({
       format: 'dd/mm/yyyy',
       startDate: new Date(), 
       autoclose: true
    })
     .on('changeDate', function(selected){
           startDate = new Date(selected.date.valueOf());
           startDate.setDate(startDate.getDate(new Date(selected.date.valueOf())));
           $('.leave-to-date').datepicker('setStartDate', startDate);
     });
     
     $('.leave-to-date').datepicker({
           format: 'dd/mm/yyyy',
           autoclose: true
       })
       .on('changeDate', function(selected){
           FromEndDate = new Date(selected.date.valueOf());
           FromEndDate.setDate(FromEndDate.getDate(new Date(selected.date.valueOf())));
           $('.leave-from-date').datepicker('setEndDate', FromEndDate);
       });
       
       
      $(".idnm2").change(function(){
       
        if ($(".rb2").prop("checked")){
          var startDate =$(".idnm1").datepicker("getDate");
          var endDate =$(".idnm2").datepicker("getDate");
          var diff = endDate - startDate;// calculating date difference will give value in milliseconds
          var days = (diff/86400000)+1; // converting milliseconds to days here we are adding 1, becuase it will give the difference of two dates
          var weeks = Math.floor(days / 7); // calculating how many weeks we have in that days
          days = days - (weeks * 2); // multiply with 2 will give how many weekends we have in those weeks
          var startDay = startDate.getDay(); //will give day of that date
          var endDay = endDate.getDay();
          if (startDay - endDay > 1) // conditons for calculating days depends on their start and end dates
            days = days - 2;
          if (startDay == 0 && endDay != 6) // it checks weather start day is sunday
            days = days - 1;
          if (endDay == 6 && startDay != 0) // it checks weather end day is saturday
            days = days - 1;
          var total_leaves = parseFloat($("#total_leaves").val());// converting value into float
          if(total_leaves<days){  // checking weather applied leaves are more than balance leaves
            $(".alert-message").show(); // it will show an alert message to the user that he crossed his balance leaves
          }
          else{
            $(".alert-message").hide();
          }
        }
      });
     
   $('.leave-date').datepicker({
       format: 'dd/mm/yyyy',
        startDate: FromEndDate,
       //endDate: '01/01/2900',
       autoclose: true
   });
   

   
    $('.float-leave-date').datepicker({
       format: 'dd/mm/yyyy',
       startDate: new Date(),
      
       autoclose: true
   })
   
    $("#leave_history_leave_type_id").change(function(){
      var leave_id = parseInt($("#leave_history_leave_type_id").val());
      if(leave_id == 2)
        {
          $('#casualleave').hide();
          $('.floatingleave').show();
          $("#full_day_from").removeAttr("required");
          $("#full_day_to").removeAttr("required");
          $("#floating_leave").prop('required', true);
          $("#half_day").removeAttr("required");
          
          //.datepicker('setDate', date);
        }
        else{
          $('.floatingleave').hide();
          $('#casualleave').show();
          $("#full_day_from").prop('required', true);
          $("#full_day_to").prop('required', true);
          $("#floating_leave").removeAttr("required");
          $("#half_day").removeAttr("required");
        }
          //console.log(leave_id);
     });
     
  
});
</script>

<% title "Apply New Leave" %>     
            

